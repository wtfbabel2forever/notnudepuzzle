<script>
  // ------- State -------
  let gameState = 'start';
  let timeLeft = 60;
  let timer;
  let selectedSlot = -1;        // ★ 선택은 "슬롯 인덱스" 기준으로 관리
  let pieces = [];              // 생성 순서 배열 (DOM 참조 저장)
  let currentImageIndex = 1;

  // ------- DOM -------
  const startScreen  = document.getElementById('start-screen');
  const gameScreen   = document.getElementById('game-screen');
  const winScreen    = document.getElementById('win-screen');
  const loseScreen   = document.getElementById('lose-screen');
  const timeDisplay  = document.getElementById('time-display');
  const swapButton   = document.getElementById('swap-button');
  const puzzleContainer = document.getElementById('puzzle-container');

  // ------- Helpers -------
  // 현재 "슬롯 인덱스(slot)"에 들어있는 실제 조각 DOM을 찾아줌
  function getPieceBySlot(slot){
    return pieces.find(p => parseInt(p.dataset.index,10) === slot);
  }
  // 모든 조각의 선택 표시 해제
  function clearSelections(){
    pieces.forEach(el => el.classList.remove('selected'));
  }
  // 타이머 UI
  function updateTimeDisplay(){
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    timeDisplay.textContent = `${m}:${s < 10 ? '0'+s : s}`;
  }
  // DOM 재배치: 0~7 슬롯 순서대로 화면에 붙이기
  function reorderPieces(){
    puzzleContainer.innerHTML = '';
    for(let slot=0; slot<8; slot++){
      const el = getPieceBySlot(slot);
      if(el) puzzleContainer.appendChild(el);
    }
  }
  // 섞기: 슬롯 번호(dataset.index)를 서로 스왑
  function shufflePieces(){
    // 충분히 섞되, 완성 상태는 피하기
    do{
      for(let i=0;i<24;i++){
        const a = (Math.random()*8)|0;
        let b;
        do{ b = (Math.random()*8)|0; } while(b===a);
        const A = getPieceBySlot(a);
        const B = getPieceBySlot(b);
        const tmp = A.dataset.index;
        A.dataset.index = B.dataset.index;
        B.dataset.index = tmp;
      }
    } while (isSolved());
    reorderPieces();
  }
  // 퍼즐 완성 체크
  function isSolved(){
    // 각 "조각"이 자신의 정답 위치(correctPosition) 슬롯에 있는가?
    return pieces.every(el =>
      parseInt(el.dataset.index,10) === parseInt(el.dataset.correctPosition,10)
    );
  }

  // ------- Game Flow -------
  function startGame(){
    gameState = 'playing';
    startScreen.classList.add('hidden');
    gameScreen.classList.remove('hidden');

    // 1~10 중 랜덤 이미지 사용 (photo1.png ~ photo10.png가 있어야 함)
    currentImageIndex = Math.floor(Math.random()*10) + 1;

    createPuzzlePieces(); // 2x4 = 8조각
    timeLeft = 60;
    updateTimeDisplay();

    timer = setInterval(()=>{
      if(--timeLeft <= 0){
        clearInterval(timer);
        showLoseScreen();
      }
      updateTimeDisplay();
    }, 1000);
  }

  function createPuzzlePieces(){
    puzzleContainer.innerHTML = '';
    puzzleContainer.style.gridTemplateColumns = 'repeat(4, 1fr)';
    pieces = [];
    selectedSlot = -1;
    swapButton.disabled = true;

    for(let i=0; i<8; i++){
      const el = document.createElement('div');
      el.className = 'puzzle-piece';
      el.dataset.correctPosition = i; // 이 조각의 정답 슬롯
      el.dataset.index = i;           // 현재 들어가 있는 슬롯(초기엔 동일)

      // 2행×4열 배경 자르기
      const row = Math.floor(i / 4);   // 0 or 1
      const col = i % 4;               // 0~3
      el.style.backgroundImage = `url(photo${currentImageIndex}.png)`;
      el.style.backgroundSize = '400% 200%';                  // 4열 × 2행
      el.style.backgroundPosition = `${col*33.33}% ${row*100}%`;

      // 클릭 시: 슬롯 인덱스 기반으로 선택
      el.addEventListener('click', () => {
        if(gameState !== 'playing') return;
        clearSelections();
        el.classList.add('selected');
        selectedSlot = parseInt(el.dataset.index, 10);
        swapButton.disabled = false;
      }, {passive:true});

      pieces.push(el);
    }
    // 섞고 그 순서대로 DOM 구성
    shufflePieces();
  }

  function swapPieces(){
    if(gameState !== 'playing' || selectedSlot === -1) return;

    // 선택된 슬롯과 "다른 랜덤 슬롯" 교환 (요청 UX 유지)
    let randomSlot;
    do { randomSlot = (Math.random()*8)|0; } while(randomSlot === selectedSlot);

    const A = getPieceBySlot(selectedSlot);
    const B = getPieceBySlot(randomSlot);

    // 슬롯 번호 교환
    const tmp = A.dataset.index;
    A.dataset.index = B.dataset.index;
    B.dataset.index = tmp;

    // 화면 갱신
    clearSelections();
    reorderPieces();

    // 상태 리셋
    selectedSlot = -1;
    swapButton.disabled = true;

    // 완성 검사
    if(isSolved()){
      clearInterval(timer);
      showWinScreen();
    }
  }

  function showWinScreen(){
    gameState = 'won';
    gameScreen.classList.add('hidden');
    winScreen.classList.remove('hidden');
  }

  function showLoseScreen(){
    gameState = 'lost';
    gameScreen.classList.add('hidden');
    loseScreen.classList.remove('hidden');
  }

  function resetGame(){
    gameState = 'start';
    selectedSlot = -1;

    winScreen.classList.add('hidden');
    loseScreen.classList.add('hidden');
    startScreen.classList.remove('hidden');

    if(timer) clearInterval(timer);
  }

  // ------- expose to buttons -------
  window.startGame = startGame;
  window.swapPieces = swapPieces;
  window.resetGame = resetGame;
</script>
